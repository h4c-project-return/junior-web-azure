#Junior Web App
This is the primary repository for Project Return's Junior web application. Beware - changes here will propagate directly to the application on Azure.

###About Junior
*Junior* is a Google Sheets spreadsheet used by the Project Return organization to catalog open job opportunities, match them to qualified participants, and track the placement process. Extensive business processes with multiple participants revolve around this spreadsheet.

###About the Junior Web Application
At the 2016 [Hack for the Community](http://hackforthecommunity.com/) event, representatives from Project Return worked with a team of technologists to analyze pain points in their usage of the Junior spreadsheet and brainstorm potential improvements. Given the spreadsheet's wide and complex usage and the Hack event's limited time window, it quickly became apparent that replacing or revamping the core tool was not feasible. However, a valuable option would be to layer some application functionality atop the spreadsheet to streamline one particularly arduous process - **matching a participant to appropriate opportunities**. The team agreed to focus here, and this repository represents the fruit of that effort.

This document describes the following major components of this web app:

1. [Spreadsheet](#spreadsheet)
2. [UI Layer](#ui-layer)
3. [API/Service Layer](#apiservice-layer)
4. [Hosting](#hosting)

## Spreadsheet
The Junior spreadsheet contains a tab named "Job Opportunities", which lists the current opportunities available to qualifying participants.

### Significant Columns
Several columns in the "Job Opportunities" tab are of specific importance to this web app.

Company Name | Conviction Restrictions |     | Conviction Threshold (Yrs) | Part Time / Full Time | Industry | Type | Required Abilities |     | Requires Driver's License
------------ | ----------------------- | --- | -------------------------- | --------------------- | -------- | ---- | ------------------ | --- | -------------------------
 | **_Violence_** | **_Drugs_** | | | | | **_Lifting_** | **_Caregiving_** |                     
Acme, Inc. - Assembly Operator | TRUE | FALSE | 5 | FT/PT | Manufacturing | Referral Partner | TRUE | FALSE | FALSE

* "Company Name": The name of the employer offering the opportunity (and possibly the job title). (Text)
* "Conviction Restrictions": A column group (merged header cell over several columns); each column has a sub-header naming a conviction that may or may not prevent a participant from qualifying for the given job. (TRUE/FALSE)
* "Conviction Threshold (Yrs)": The number of years after which the Conviction Restrictions no longer apply to the given job. (Number)
* "Part Time / Full Time": The work schedule for the opportunity. If the cell includes "PT", the given job will be treated as having a part-time option available. (Text, possibly containing 'PT')
* "Industry": The name of the industry the employer operates in. (Text)
* "Type": Distinguishes various placement arrangements between Project Return and the employer. (Text)
* "Required Abilities": A column group (merged header cell over several columns); each column has a sub-header naming some ability that may or may not be required for work in the given job. (TRUE/FALSE)
* "Requires Driver's License": Whether a participant must have a license in order to qualify for the given job. (TRUE/FALSE)

Note: Additional columns are allowed, and will be displayed on the app's opportunity detail screen.

### Authorization
The app uses the Google Apps API's OAuth capability to secure access to Project Return's proprietary job opportunity data. Access to the spreadsheet is secured at two levels:

1. *To this application* - using a Client Id/Client Secret pair generated by Google API.
2. *Per end user* - using the person's Google credentials and access rights to the spreadsheet.

It is important to note that without both those elements (client app credentials and end-user credentials), the spreadsheet cannot be accessed through this app.

#### Authorization Setup
1. Create client application credentials. (See [Using OAuth 2.0 for Web Server Applications](https://developers.google.com/identity/protocols/OAuth2WebServer) from Google API documentation.)
   * Add the app's login URL (http://[app_domain].azurewebsites.net/login) as an "Authorized redirect URI".
2. Make sure the Sheets API is enabled.

## UI Layer
This is a client-side Single-Page Web application built in HTML/JS/CSS, using the [Vue framework](https://vuejs.org/). The source code for this layer is maintained in this repository's sibling named "[project-return-client](https://github.com/h4c-project-return/project-return-client)". The build output from that codebase is then checked into this repository at the following path for inclusion in the Azure deployment: [/junior_web/static](https://github.com/h4c-project-return/junior-web-azure/tree/master/junior_web/static)
  
Detailed documentation on working within and building the UI Layer's codebase are pending.

## API/Service Layer
This is a [Python](https://www.python.org/) & [Flask](http://flask.pocoo.org/)-based web application that provides a Rest-style web API, along with serving the static SPA artifacts from the UI Layer ([above](#ui-layer)). The API/Service Layer is responsible for facilitating authorization of access to the [Spreadsheet](#spreadsheet), then reading the spreadsheet data and executing queries against it based on user-input search criteria (from the [UI Layer](#ui-layer).

### Code Structure
The major elements of the codebase are as follows:

1. `/` (root): Azure boilerplate (and this documentation)
2. `/junior_web/`: Core Python/Flask codebase
   * `jr_services.py`: Flask app, supporting functions
   * `jr_config.py`: Reads environment variables, supplies defaults where applicable
   * `google_authorization.py`: Wraps Google's authorization API
   * `google_sheets.py`: Wraps Google's Sheets API
   * `opportunity_parsing.py`: Reads data from spreadsheet
   * `opportunity_filtering.py`: Applies user-supplied qualification criteria over data from spreadsheet
   * `general_functions.py`: Helper functions from a first-time Python programmer.
   * `static/`: Holds the built [UI Layer](ui-layer).
   * `schema/`: Contains the JSON schema used to validate API input.
3. `/env/`: Python virtual environment (Best luck so far with Azure hosting (below) has been to maintain a virtual environment and `/requirements.txt` file (using `pip freeze > requirements.txt`), and check the whole `env` into GitHub for deployment to Azure.)

### Local Development Environment Setup

1. Install Python 2.7.
2. Make sure virtualenv is installed.
   * `pip install virtualenv`
3. Pull this repository to local disk.
4. Rebuild the virtual environment.
   1. Delete the `/env` directory.
   2. Create the virtual environment.
      * `virtualenv env` (from repo root)
   3. Activate the virtual environment.
      * `source env/scripts/activate` (BASH)
      * `env\scripts\activate.bat` (Windows)
   4. Rebuild dependencies.
      * `pip install -r requirements.txt` (from repo root)
5. Create a fake DNS entry on your machine matching a redirect URI that Google API will accept.
   1. Open your operating system's `hosts` file (`C:\Windows\System32\drivers\etc\hosts` on Windows).
   2. Add a line in the form `  127.0.0.1  myfakedomain.com`.
6. Run the application.
   1. Set the local web server port (this must match the same Google API redirect URI referenced above).
      * `export SERVER_PORT="4200"` (Bash)
      * `set SERVER_PORT=4200` (Windows)
   2. Start the Python application.
      * `python runserver.py`
   3. Open the app in your browser, i.e. `http://myfakedomain:4200/`.
   

## Hosting
The Junior web application is currently hosted on the [Azure](https://azure.microsoft.com/) cloud, using nonprofit grant credits donated by Microsoft in conjunction with the Hack for the Community event. In the original development context, Azure offered several advantages over other options considered, including:
* PaaS (no VM management required)
* Free subdomain (no DNS maintenance required)
* Automated deployment upon GitHub commit

However, it should be noted that Python support on Azure still seems somewhat immature. The base hosting setup in use at time of writing was derived from the [PTVS team's Flask hosting instructions](https://docs.microsoft.com/en-us/azure/app-service-web/web-sites-python-create-deploy-flask-app) and [artifacts](https://github.com/azureappserviceoss/FlaskAzure). This appears to be a work in process, with improvements and alternatives being discussed regularly on various blog posts.

### Deployment
Notwithstand the preceeding, setting up Azure to host this application is fairly straightforward:

1. Create new App Service.
   1. Search for and select the "Flask" option from PTVS.
   2. Place the App Service on a "Standard: 1 Small" Service plan. (Basic didn't seem to work, though I'm not sure why.)
2. Attach the new App Service to this GitHub repository.
   1. Under Deployment Options, Disconnect the pre-built option.
   2. Connect to GitHub to automatically pull code committed here.
3. Configure the application. 
Under Application Settings, configure the following name-value-pair App Settings:
   * `FLASK_SECRET_KEY`: A unique, unguessable string used to encrypt users' session cookies (e.g., a [GUID](https://www.guidgenerator.com/))
   * `GOOGLE_OAUTH_CLIENT_ID`: Client Id from Google Apps OAuth configuration
   * `GOOGLE_OAUTH_CLIENT_SECRET`: Client Secret from Google Apps OAuth configuration
   * `GOOGLE_SHEET_ID`: Sheet Id from Google Sheets
   * `GOOGLE_SHEET_RANGE_NAME`: The name of the Job Opportunities spreadsheet tab

### Troubleshooting
An ongoing frustration with this hosting setup is that it is not yet apparent how to get straightforward error logging from Flask out into the Azure environment. This stems from the fact that Flask logs to STDOUT by default, but CGI/WSGI co-opt STDOUT for the HTTP response itself.

However, runtime errors experienced to-date boil down to a very short list of causes:
 
1. Invalid configuration. (See above.)
2. Insufficient end-user authorization. (Must be able to view the Google Sheets spreadsheet directly.)

Beyond these, most issues are better reproduced locally, where Flask can output errors to STDOUT.
